<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·∫∑t M√≥n - Pizza</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding-bottom: 100px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      color: #e74c3c;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .table-info {
      background: #e74c3c; 
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      display: inline-block;
      font-weight: 700;
      font-size: 18px;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .store-badge {
      background: #3498db;
      color: white;
      padding: 8px 16px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
      display: inline-block;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab {
      flex: 1;
      background: white;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #777;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .tab.active {
      background: #e74c3c; 
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .menu-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .category-section {
      border-bottom: 1px solid #f0f0f0;
    }

    .category-section:last-child {
      border-bottom: none;
    }

    .category-header {
      background: #e74c3c;
      color: white;
      padding: 18px 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }

    .category-header:active {
      background:  #c0392b; 
    }

    .category-icon {
      font-size: 20px;
      transition: transform 0.3s;
    }

    .category-icon.rotate {
      transform: rotate(180deg);
    }

    .category-items {
      display: none;
      padding: 10px;
    }

    .category-items.show {
      display: block;
    }

    .menu-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 2px solid #f0f0f0;
      border-radius: 12px;
      margin-bottom: 10px;
      transition: all 0.3s;
      background: white;
    }

    .menu-item:active {
      transform: scale(0.98);
    }

    .menu-item.has-items {
      border-color: #e74c3c;
      background: #fff5f5;
    }

    .item-info strong {
      display: block;
      margin-bottom: 5px;
      color: #333;
      font-size: 15px;
    }

    .item-price {
      color: #e74c3c;
      font-weight: 700;
      font-size: 16px;
    }

    .quantity-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .qty-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background:  #e74c3c; 
      color: white;
      border: none;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
      font-weight: 600;
    }

    .qty-btn:active {
      transform: scale(0.9);
    }

    .qty-display {
      min-width: 40px;
      text-align: center;
      font-weight: 700;
      font-size: 20px;
      color: #333;
    }

    .cart-float {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #e74c3c; 
      color: white;
      padding: 18px 35px;
      border-radius: 50px;
      box-shadow: 0 8px 24px rgba(231, 76, 60, 0.5);
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      display: none;
      z-index: 1000;
      transition: all 0.3s;
      max-width: 90%;
    }

    .cart-float:active {
      transform: translateX(-50%) scale(0.95);
    }

    .cart-float.show {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .cart-badge {
      background: white;
      color: #e74c3c;
      border-radius: 50%;
      min-width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      padding: 0 8px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: slideUp 0.3s;
      max-height: 85vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      background: #e74c3c;
      color: white;
      padding: 25px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modal-header h2 {
      font-size: 22px;
    }

    .close-btn {
      background: white;
      color: #e74c3c;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      font-weight: 700;
    }

    .close-btn:active {
      transform: rotate(90deg) scale(0.9);
    }

    .modal-body {
      padding: 25px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border: 2px solid #f0f0f0;
      border-radius: 12px;
      margin-bottom: 12px;
      background: #fafafa;
    }

    .cart-item-info {
      flex: 1;
    }

    .cart-item-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .cart-item-price {
      color: #e74c3c;
      font-weight: 600;
      font-size: 14px;
    }

    .cart-total {
      background: #e74c3c;
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .action-btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .order-btn {
      background: #27ae60;  /* Thay v√¨ gradient */
      color: white;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .order-btn:active {
      transform: scale(0.98);
    }

    .continue-btn {
      background: #95a5a6;
      color: white;
    }

    .continue-btn:active {
      transform: scale(0.98);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .current-order-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-total {
      background: #e74c3c; 
      color: white;
      padding: 15px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 18px;
      margin-top: 15px;
    }

    .note-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 15px;
      font-family: inherit;
    }

    .note-input:focus {
      outline: none;
      border-color: #e74c3c;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 1px solid #c3e6cb;
      text-align: center;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçï Pizza Menu</h1>
      <div class="table-info" id="tableInfo">ƒêang t·∫£i...</div>
      <div class="store-badge" id="storeBadge"></div>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab(0)">üìã Menu</div>
      <div class="tab" onclick="switchTab(1)">üõí ƒê∆°n c·ªßa t√¥i</div>
    </div>

    <!-- Tab Menu -->
    <div class="tab-content active" id="tabMenu">
      <div class="menu-container" id="menuCategories"></div>
    </div>

    <!-- Tab Current Order -->
    <div class="tab-content" id="tabOrder">
      <div id="currentOrderContent"></div>
    </div>
  </div>

  <!-- Cart Float Button -->
  <div class="cart-float" id="cartFloat" onclick="openCart()">
    <span>üõí Gi·ªè h√†ng</span>
    <span class="cart-badge" id="cartCount">0</span>
    <span id="cartTotal">0ƒë</span>
  </div>

  <!-- Cart Modal -->
  <div id="cartModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üõí Gi·ªè H√†ng</h2>
        <button class="close-btn" onclick="closeCart()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="cartItems"></div>
        <div class="cart-total">
          <span>T·ªîNG C·ªòNG:</span>
          <span id="modalTotal">0ƒë</span>
        </div>
        <input type="text" class="note-input" id="orderNote" placeholder="Ghi ch√∫ ƒë∆°n h√†ng (t√πy ch·ªçn)">
        <button class="action-btn order-btn" onclick="submitOrder()">‚úÖ ƒê·∫∑t m√≥n ngay</button>
        <button class="action-btn continue-btn" onclick="closeCart()">‚Üê Ch·ªçn th√™m m√≥n</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const menuData = {
      'Pizza': [
        { id: 'p1', name: 'B√≤ (Size S)', price: 39000 },
        { id: 'p2', name: 'Ph√¥ mai (Size S)', price: 39000 },
        { id: 'p3', name: 'G√† teriyaki (Size S)', price: 39000 },
        { id: 'p4', name: 'X√∫c x√≠ch heo (Size S)', price: 39000},
        { id: 'p5', name: 'C√° ng·ª´ (Size S)', price: 39000 },
{ id: 'p6', name: 'Ba r·ªçi x√¥ng kh√≥i (Size S)', price: 39000 },
{ id: 'p7', name: 'B√≤ (Size L)', price: 89000 },
{ id: 'p8', name: 'Ph√¥ mai (Size L)', price: 89000 },
{ id: 'p9', name: 'G√† teriyaki (Size L)', price: 89000 },
{ id: 'p10', name: 'H·∫£i s·∫£n (Size L)', price: 89000 },
{ id: 'p11', name: 'X√∫c x√≠ch heo (Size L)', price: 89000 },
{ id: 'p12', name: 'Pizza n·∫•m rau c·ªß (Size L)', price: 89000 },
{ id: 'p13', name: 'X√∫c x√≠ch ƒê·ª©c (Size L)', price: 89000 },
{ id: 'p14', name: 'C√° ng·ª´ (Size L)', price: 89000 },
{ id: 'p15', name: 'Ba r·ªçi x√¥ng kh√≥i (Size L)', price: 89000 },
{ id: 'p16', name: 'Salami (Size L)', price: 109000 },
{ id: 'p17', name: 'Ph√¥ mai t∆∞∆°i (Size L)', price: 99000 },
{ id: 'p18', name: "Meat Lover's (Size L)", price: 109000 },
{ id: 'p19', name: 'T√¥m thanh cua (Size L)', price: 99000 },
{ id: 'p20', name: 'Kh√¥ G√† - L·∫°p X∆∞·ªüng (Size L)', price: 99000 },
{ id: 'p21', name: 'Th·∫≠p C·∫©m (Size L)', price: 109000 },
{ id: 'p22', name: 'B√≤ s·ªët cay (Size L)', price: 109000 },
{ id: 'p23', name: 'H·∫£i s·∫£n ƒë·∫∑c bi·ªát (Size L)', price: 99000 }
],
'M√≥n ƒÇn Nh·∫π': [
{ id: 's1', name: 'G√† S·ªët Cay', price: 29000 },
{ id: 's2', name: 'Khoai t√¢y chi√™n (nh·ªè)', price: 15000 },
{ id: 's3', name: 'Khoai t√¢y chi√™n (l·ªõn)', price: 25000 },
{ id: 's4', name: 'Tok L·∫Øc Ph√¥ Mai', price: 15000 },
{ id: 's5', name: 'B√°nh M√¨ B∆° T·ªèi', price: 15000 },
{ id: 's6', name: 'G√† l·∫Øc ph√¥ mai cay (nh·ªè)', price: 25000 },
{ id: 's7', name: 'G√† l·∫Øc ph√¥ mai cay (l·ªõn)', price: 35000 },
{ id: 's8', name: 'G√† r√°n chi√™n gi√≤n (nh·ªè)', price: 25000 },
{ id: 's9', name: 'G√† r√°n chi√™n gi√≤n (l·ªõn)', price: 30000 },
{ id: 's10', name: 'M√¨ √ù ƒë√∫t l√≤', price: 59000 },
{ id: 's11', name: 'M√¨ √ù s·ªët b√≤ b·∫±m', price: 39000 },
{ id: 's12', name: 'Salad C√° Ng·ª´', price: 39000 },
{ id: 's13', name: 'Salad d·∫ßu gi·∫•m', price: 29000 },
{ id: 's14', name: 'B√°nh m√¨ ph√¥ mai', price: 25000 },
{ id: 's15', name: 'B·∫Øp Ph√¥ Mai', price: 29000 }
],
'N∆∞·ªõc': [
{ id: 'd1', name: 'N∆∞·ªõc ng·ªçt (ly)', price: 9000 },
{ id: 'd2', name: 'N∆∞·ªõc ng·ªçt (lon)', price: 15000 },
{ id: 'd3', name: 'N∆∞·ªõc su·ªëi', price: 9000 },
{ id: 'd4', name: 'Local Beer', price: 15000 },
{ id: 'd5', name: 'ƒê√° me h·∫°t m·ªÅm', price: 15000 },
{ id: 'd6', name: 'Tr√† Chanh', price: 15000 },
{ id: 'd7', name: 'Tr√† ƒê√†o', price: 20000 },
{ id: 'd8', name: 'Tr√† s·ªØa Th√°i', price: 20000 }
],
'Combo': [
{ id: 'c1', name: 'Combo 1 (1 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 2 n∆∞·ªõc ng·ªçt)', price: 119000 },
{ id: 'c2', name: 'Combo 2 (1 Pizza b·∫•t k·ª≥ + 3 g√† r√°n + 3 n∆∞·ªõc ng·ªçt)', price: 179000 },
{ id: 'c3', name: 'Combo 3 (2 Pizza b·∫•t k·ª≥ + 1 g√† l·∫Øc ph√¥ mai cay + 1 khoai t√¢y chi√™n + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },
{ id: 'c4', name: 'Combo 4 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 n∆∞·ªõc ng·ªçt)', price: 139000 },
{ id: 'c5', name: 'Combo 5 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 2 m√¨ √ù + 4 n∆∞·ªõc ng·ªçt)', price: 229000 },
{ id: 'c6', name: 'Combo 6 (1 Pizza b·∫•t k·ª≥ + 1 salad c√° ng·ª´ + 1 m√¨ √ù + 2 n∆∞·ªõc ng·ªçt)', price: 159000 },
{ id: 'c7', name: 'Combo 7 (1 Pizza size S b·∫•t k·ª≥ + 1 n∆∞·ªõc ng·ªçt)', price: 45000 },
{ id: 'c8', name: 'Combo 8 (1 Pizza size S b·∫•t k·ª≥ + 1 khoai t√¢y chi√™n + 1 n∆∞·ªõc ng·ªçt)', price: 59000 }
]
};
const SUPABASE_URL = 'https://mhmvtywqtaqikaubhhmf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obXZ0eXdxdGFxaWthdWJoaG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDA4MTMsImV4cCI6MjA3ODYxNjgxM30.VDRLH8sTCkoZfJes3VJfHJhXsaCla9PkM2WcPL5T0Ds';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let storeCode = '';
let tableNumber = '';
let cart = {};
let currentOrders = [];

// Kh·ªüi t·∫°o
async function init() {
  // ƒê·ªçc token t·ª´ URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  if (!token) {
    showExpiredScreen('Link kh√¥ng h·ª£p l·ªá! Vui l√≤ng qu√©t l·∫°i m√£ QR.');
    return;
  }

  // Validate token
  const sessionValid = await validateToken(token);
  if (!sessionValid) {
    showExpiredScreen('Phi√™n ƒë√£ h·∫øt h·∫°n ho·∫∑c kh√¥ng h·ª£p l·ªá!<br>Vui l√≤ng qu√©t l·∫°i m√£ QR t·ª´ b√†n.');
    return;
  }

  // L∆∞u token ƒë·ªÉ check sau n√†y
  window.sessionToken = token;

  // L·∫•y th√¥ng tin t·ª´ session
  storeCode = sessionValid.store_code;
  tableNumber = sessionValid.table_number;

  const storeNames = {
    'DH': 'Di√™n H·ªìng',
    'NH': 'Nguy·ªÖn Hu·ªá',
    'HXH': 'H·ªì Xu√¢n H∆∞∆°ng',
    'PY': 'Ph√∫ Y√™n'
  };

  document.getElementById('tableInfo').textContent = `üçΩÔ∏è B√†n ${tableNumber}`;
  document.getElementById('storeBadge').textContent = storeNames[storeCode] || storeCode;

  renderMenu();
  loadCurrentOrders();
  subscribeToOrders();
}

// Th√™m h√†m validate token
async function validateToken(token) {
  try {
    const { data, error } = await supabase
      .from('qr_sessions')
      .select('*')
      .eq('token', token)
      .single();

    if (error || !data) return false;

    // Check h·∫øt h·∫°n ch∆∞a
    const expiresAt = new Date(data.expires_at);
    const now = new Date();
    
    if (now > expiresAt) {
      // X√≥a token h·∫øt h·∫°n
      await supabase.from('qr_sessions').delete().eq('token', token);
      return false;
    }

    return data;

  } catch (error) {
    console.error('L·ªói validate token:', error);
    return false;
  }
}

// Th√™m h√†m hi·ªÉn th·ªã m√†n h√¨nh h·∫øt h·∫°n
function showExpiredScreen(message) {
  document.body.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #f5f5f5; padding: 20px; text-align: center;">
      <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 400px;">
        <div style="font-size: 64px; margin-bottom: 20px;">‚è±Ô∏è</div>
        <h2 style="color: #333; margin-bottom: 15px;">Phi√™n ƒë√£ h·∫øt h·∫°n</h2>
        <p style="color: #777; line-height: 1.6;">${message}</p>
      </div>
    </div>
  `;
}

function renderMenu() {
  const container = document.getElementById('menuCategories');
  
  container.innerHTML = Object.keys(menuData).map(category => {
    const items = menuData[category].map(item => `
      <div class="menu-item ${(cart[item.id] || 0) > 0 ? 'has-items' : ''}">
        <div class="item-info">
          <strong>${item.name}</strong>
          <div class="item-price">${formatMoney(item.price)}</div>
        </div>
        <div class="quantity-control">
          <button class="qty-btn" onclick="updateCart('${item.id}', -1)">-</button>
          <span class="qty-display">${cart[item.id] || 0}</span>
          <button class="qty-btn" onclick="updateCart('${item.id}', 1)">+</button>
        </div>
      </div>
    `).join('');

    return `
      <div class="category-section">
        <div class="category-header" onclick="toggleCategory('${category}')">
          <span>üìÅ ${category}</span>
         <span class="category-icon rotate" id="icon-${category}">‚ñº</span>
        </div>
        <div class="category-items show" id="items-${category}">
          ${items}
        </div>
      </div>
    `;
  }).join('');
}

function toggleCategory(category) {
  const items = document.getElementById(`items-${category}`);
  const icon = document.getElementById(`icon-${category}`);
  
  items.classList.toggle('show');
  icon.classList.toggle('rotate');
}

function updateCart(itemId, change) {
  if (!cart[itemId]) cart[itemId] = 0;
  cart[itemId] += change;
  if (cart[itemId] <= 0) delete cart[itemId];
  
  // Ch·ªâ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng v√† gi√°, KH√îNG render l·∫°i to√†n b·ªô menu
  updateItemDisplay(itemId);
  updateCartFloat();
}

// Th√™m h√†m m·ªõi n√†y ƒë·ªÉ ch·ªâ c·∫≠p nh·∫≠t item c·ª• th·ªÉ
function updateItemDisplay(itemId) {
  const item = findItemById(itemId);
  if (!item) return;
  
  // T√¨m v√† c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng hi·ªÉn th·ªã
  const qtyDisplays = document.querySelectorAll('.qty-display');
  const menuItems = document.querySelectorAll('.menu-item');
  
  menuItems.forEach((menuItem, index) => {
    const qtyBtn = menuItem.querySelector('.qty-btn');
    if (qtyBtn && qtyBtn.getAttribute('onclick').includes(itemId)) {
      const qtyDisplay = menuItem.querySelector('.qty-display');
      qtyDisplay.textContent = cart[itemId] || 0;
      
      // C·∫≠p nh·∫≠t class has-items
      if ((cart[itemId] || 0) > 0) {
        menuItem.classList.add('has-items');
      } else {
        menuItem.classList.remove('has-items');
      }
    }
  });
}

function updateCartFloat() {
  const totalItems = Object.values(cart).reduce((sum, qty) => sum + qty, 0);
  const totalAmount = Object.keys(cart).reduce((sum, itemId) => {
    const item = findItemById(itemId);
    return sum + (item ? item.price * cart[itemId] : 0);
  }, 0);

  const cartFloat = document.getElementById('cartFloat');
  document.getElementById('cartCount').textContent = totalItems;
  document.getElementById('cartTotal').textContent = formatMoney(totalAmount);

  if (totalItems > 0) {
    cartFloat.classList.add('show');
  } else {
    cartFloat.classList.remove('show');
  }
}

function findItemById(itemId) {
  for (const category in menuData) {
    const item = menuData[category].find(i => i.id === itemId);
    if (item) return item;
  }
  return null;
}

function openCart() {
  if (Object.keys(cart).length === 0) return;
  
  const modal = document.getElementById('cartModal');
  const cartItems = document.getElementById('cartItems');
  
  let html = '';
  let total = 0;

  Object.keys(cart).forEach(itemId => {
    const item = findItemById(itemId);
    if (!item) return;
    
    const qty = cart[itemId];
    const subtotal = item.price * qty;
    total += subtotal;

    html += `
      <div class="cart-item">
        <div class="cart-item-info">
          <div class="cart-item-name">${item.name}</div>
          <div class="cart-item-price">${formatMoney(item.price)} x ${qty}</div>
        </div>
        <div style="font-weight: 700; color: #e74c3c; font-size: 16px;">
          ${formatMoney(subtotal)}
        </div>
      </div>
    `;
  });

  cartItems.innerHTML = html;
  document.getElementById('modalTotal').textContent = formatMoney(total);
  modal.style.display = 'block';
}

function closeCart() {
  document.getElementById('cartModal').style.display = 'none';
}

async function submitOrder() {
  if (Object.keys(cart).length === 0) {
    alert('Gi·ªè h√†ng tr·ªëng!');
    return;
  }

  // ‚≠ê TH√äM ƒêO·∫†N N√ÄY - Validate token tr∆∞·ªõc khi ƒë·∫∑t m√≥n
  const sessionValid = await validateToken(window.sessionToken);
  if (!sessionValid) {
    alert('‚è±Ô∏è Phi√™n ƒë√£ h·∫øt h·∫°n!\n\nVui l√≤ng qu√©t l·∫°i m√£ QR t·ª´ b√†n.');
    window.location.reload();
    return;
  }

  const note = document.getElementById('orderNote').value.trim();

  const order = {
    id: Date.now(),
    store_code: storeCode,
    user_id: `qr_${storeCode}_table${tableNumber}`,
    table_number: tableNumber,
    session_token: window.sessionToken,  // ‚≠ê TH√äM token v√†o ƒë∆°n h√†ng
    order_type: 'dine',
    order_source: 'qr',
    note: note,
    items: {...cart},
    total: Object.keys(cart).reduce((sum, id) => {
      const item = findItemById(id);
      return sum + (item ? item.price * cart[id] : 0);
    }, 0),
    status: 'pending',
    created_at: new Date().toISOString()
  };

  try {
    const { error } = await supabase
      .from('orders')
      .insert([order]);

    if (error) throw error;

    cart = {};
    document.getElementById('orderNote').value = '';
    closeCart();
    renderMenu();
    updateCartFloat();
    
    alert('‚úÖ ƒê·∫∑t m√≥n th√†nh c√¥ng!\n\nM√≥n c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c chu·∫©n b·ªã. Vui l√≤ng ch·ªù trong gi√¢y l√°t.');
    
    switchTab(1);
    loadCurrentOrders();

  } catch (error) {
    console.error('L·ªói ƒë·∫∑t m√≥n:', error);
    alert('‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
  }
}

async function loadCurrentOrders() {
  try {
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .eq('store_code', storeCode)
      .eq('table_number', tableNumber)
      .eq('status', 'pending')
      .order('created_at', { ascending: false });

    if (error) throw error;

    currentOrders = data || [];
    renderCurrentOrders();

  } catch (error) {
    console.error('L·ªói load ƒë∆°n h√†ng:', error);
  }
}

function renderCurrentOrders() {
  const container = document.getElementById('currentOrderContent');
  
  if (currentOrders.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üçï</div>
        <h3>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</h3>
        <p style="margin-top: 10px;">H√£y ch·ªçn m√≥n t·ª´ menu nh√©!</p>
      </div>
    `;
    return;
  }

  let html = '';
  let grandTotal = 0;

  currentOrders.forEach(order => {
    let itemsHtml = '';
    Object.keys(order.items).forEach(itemId => {
      const item = findItemById(itemId);
      if (!item) return;
      
      const qty = order.items[itemId];
      const subtotal = item.price * qty;

      itemsHtml += `
        <div class="order-item">
          <span>${item.name} x ${qty}</span>
          <strong>${formatMoney(subtotal)}</strong>
        </div>
      `;
    });

    grandTotal += order.total;

    html += `
      <div class="current-order-card">
        <div style="margin-bottom: 10px; color: #999; font-size: 13px;">
          ${new Date(order.created_at).toLocaleTimeString('vi-VN')}
        </div>
        ${order.note ? `<div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px;">üìù ${order.note}</div>` : ''}
        ${itemsHtml}
        <div class="order-total">
          <span>T·ªïng:</span>
          <span>${formatMoney(order.total)}</span>
        </div>
      </div>
    `;
  });

  if (currentOrders.length > 1) {
    html += `
      <div class="current-order-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">
        <div style="display: flex; justify-content: space-between; font-size: 20px; font-weight: 700;">
          <span>T·ªîNG C·ªòNG:</span>
          <span>${formatMoney(grandTotal)}</span>
        </div>
      </div>
    `;
  }

  html += `
    <div style="background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 12px; margin-top: 15px; text-align: center; font-size: 14px; border: 1px solid #bee5eb;">
      ‚ÑπÔ∏è Vui l√≤ng thanh to√°n v·ªõi nh√¢n vi√™n khi nh·∫≠n m√≥n
    </div>
  `;

  container.innerHTML = html;
}

function subscribeToOrders() {
  supabase
    .channel('customer-orders')
    .on('postgres_changes', 
      { 
        event: '*', 
        schema: 'public', 
        table: 'orders',
        filter: `table_number=eq.${tableNumber}`
      }, 
      (payload) => {
        loadCurrentOrders();
      }
    )
    .subscribe();
}

function switchTab(index) {
  document.querySelectorAll('.tab').forEach((tab, i) => {
    tab.classList.toggle('active', i === index);
  });
  document.querySelectorAll('.tab-content').forEach((content, i) => {
    content.classList.toggle('active', i === index);
  });

  if (index === 1) {
    loadCurrentOrders();
  }
}

function formatMoney(amount) {
  return amount.toLocaleString('vi-VN') + 'ƒë';
}

// Close modal when click outside
window.onclick = function(event) {
  const modal = document.getElementById('cartModal');
  if (event.target == modal) {
    closeCart();
  }
}

async function validateToken(token) {
  try {
    const { data, error } = await supabase
      .from('qr_sessions')
      .select('*')
      .eq('token', token)
      .single();

    if (error) {
      console.error('‚ùå Token validation error:', error);
      return false;
    }

    if (!data) {
      console.error('‚ùå Token not found in database');
      return false;
    }

    // ‚úÖ FIX: So s√°nh ƒë√∫ng c√°ch
    const expiresAt = new Date(data.expires_at);
    const now = new Date();
    
    console.log('üïê Current time:', now.toISOString(), '/', now.toLocaleString('vi-VN'));
    console.log('‚è∞ Token expires:', expiresAt.toISOString(), '/', expiresAt.toLocaleString('vi-VN'));
    console.log('‚è±Ô∏è Time left:', Math.round((expiresAt - now) / 1000 / 60), 'minutes');
    
    if (now >= expiresAt) {
      console.warn('‚ö†Ô∏è Token expired!');
      await supabase.from('qr_sessions').delete().eq('token', token);
      return false;
    }

    console.log('‚úÖ Token valid!');
    return data;

  } catch (error) {
    console.error('üî• Validate token exception:', error);
    return false;
  }
}

// Kh·ªüi ƒë·ªông
init();
</script>
</body>
</html>
