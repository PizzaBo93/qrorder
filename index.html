<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒêang k·∫øt n·ªëi...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }

    .loading-box {
      background: white;
      border-radius: 24px;
      padding: 50px 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 400px;
      width: 100%;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #f0f0f0;
      border-top: 4px solid #e74c3c;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 25px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .icon {
      font-size: 64px;
      margin-bottom: 15px;
      animation: bounce 1.5s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    h2 {
      color: #333;
      margin-bottom: 10px;
      font-size: 22px;
    }

    p {
      color: #777;
      line-height: 1.6;
      font-size: 15px;
    }

    .error-box {
      background: #fff5f5;
      border: 2px solid #e74c3c;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }

    .error-box.show {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .error-text {
      color: #e74c3c;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .retry-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 15px;
    }

    .retry-btn:active {
      transform: scale(0.95);
    }

    .info-badge {
      background: #e3f2fd;
      color: #1976d2;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      margin-top: 15px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <div class="loading-box">
    <div class="icon">üçï</div>
    <div class="spinner" id="spinner"></div>
    <h2 id="statusTitle">ƒêang k·∫øt n·ªëi...</h2>
    <p id="statusText">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
    <div class="info-badge" id="infoBadge" style="display: none;"></div>
    
    <div class="error-box" id="errorBox">
      <p class="error-text" id="errorText"></p>
      <button class="retry-btn" onclick="location.reload()">üîÑ Th·ª≠ l·∫°i</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://mhmvtywqtaqikaubhhmf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obXZ0eXdxdGFxaWthdWJoaG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDA4MTMsImV4cCI6MjA3ODYxNjgxM30.VDRLH8sTCkoZfJes3VJfHJhXsaCla9PkM2WcPL5T0Ds';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const storeNames = {
      'DH': 'Di√™n H·ªìng',
      'NH': 'Nguy·ªÖn Hu·ªá',
      'HXH': 'H·ªì Xu√¢n H∆∞∆°ng',
      'PY': 'Ph√∫ Y√™n'
    };

    function showError(message) {
      document.getElementById('statusTitle').textContent = '‚ùå C√≥ l·ªói x·∫£y ra';
      document.getElementById('statusText').style.display = 'none';
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('infoBadge').style.display = 'none';
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorBox').classList.add('show');
    }

    function showInfo(store, table) {
      const badge = document.getElementById('infoBadge');
      badge.textContent = `${storeNames[store] || store} - B√†n ${table}`;
      badge.style.display = 'inline-block';
    }

    async function createSession() {
      const urlParams = new URLSearchParams(window.location.search);
      const store = urlParams.get('store');
      const table = urlParams.get('table');

      // Validate params
      if (!store || !table) {
        showError('Link QR kh√¥ng h·ª£p l·ªá! Thi·∫øu th√¥ng tin b√†n ho·∫∑c chi nh√°nh.');
        return;
      }

      const storeCode = store.toUpperCase();

      // Validate store code
      if (!storeNames[storeCode]) {
        showError(`Chi nh√°nh "${store}" kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng!`);
        return;
      }

      // Validate table number
      if (isNaN(table) || parseInt(table) < 1) {
        showError('S·ªë b√†n kh√¥ng h·ª£p l·ªá!');
        return;
      }

      // Show info
      showInfo(storeCode, table);

      try {
        // X√≥a t·∫•t c·∫£ session c≈© c·ªßa b√†n n√†y
        await supabase
          .from('qr_sessions')
          .delete()
          .eq('store_code', storeCode)
          .eq('table_number', table);

        // T·∫°o token m·ªõi
        const token = generateSecureToken();
        const expiresAt = new Date();
        expiresAt.setHours(expiresAt.getHours() + 1); // Th√™m 1 gi·ªù

        // Insert session m·ªõi
        const { data, error } = await supabase
          .from('qr_sessions')
          .insert([{
            token: token,
            store_code: storeCode,
            table_number: table,
            expires_at: expiresAt.toISOString(),
            created_at: new Date().toISOString()
          }])
          .select()
          .single();

        if (error) throw error;

        // Update status
        document.getElementById('statusTitle').textContent = '‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!';
        document.getElementById('statusText').textContent = 'ƒêang chuy·ªÉn ƒë·∫øn menu...';

        // ƒê·ª£i 400ms ƒë·ªÉ ƒë·∫£m b·∫£o data ƒë√£ l∆∞u + UX m∆∞·ª£t h∆°n
        await new Promise(resolve => setTimeout(resolve, 400));

        // Redirect ƒë·∫øn trang menu v·ªõi token
        window.location.href = `menu.html?token=${token}`;

      } catch (error) {
        console.error('L·ªói t·∫°o session:', error);
        
        // X·ª≠ l√Ω c√°c lo·∫°i l·ªói kh√°c nhau
        if (error.code === '23505') {
          // Duplicate key - ƒëang t·∫°o session
          showError('ƒêang c√≥ phi√™n kh√°c ƒëang k·∫øt n·ªëi. Vui l√≤ng ƒë·ª£i 3 gi√¢y v√† th·ª≠ l·∫°i!');
        } else if (error.message?.includes('Failed to fetch')) {
          showError('Kh√¥ng c√≥ k·∫øt n·ªëi internet. Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i!');
        } else {
          showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn h·ªá th·ªëng. Vui l√≤ng th·ª≠ l·∫°i sau!');
        }
      }
    }

    function generateSecureToken() {
      const timestamp = Date.now();
      const random1 = Math.random().toString(36).substring(2, 15);
      const random2 = Math.random().toString(36).substring(2, 15);
      return `qr_${timestamp}_${random1}${random2}`;
    }

    // Auto run khi trang load
    createSession();
  </script>
</body>
</html>
